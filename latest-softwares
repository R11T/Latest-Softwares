#!/usr/bin/php
<?php

$required = [
    'Const.php', 'Vendor/autoload.php'
];

require_once 'dependencies.php';

loadDependencies($required);

try {
    $request = new \App\Library\Io\Request($argv, $argc);
    \App\Singleton::request($request);
    \App\Singleton::response((new \App\Library\Io\Response()));
    \App\Singleton::router((new \App\Router($request)));
    \App\Singleton::db(new \App\Library\Db(DATA_DIR . 'db.sqlite'));
    \App\Singleton::db()->exec('PRAGMA foreign_keys=ON');
    \App\Singleton::mainFactory(new \App\Library\Factory());

} catch (\Exception $e) {
    echo "Fatal error : " . $e->getMessage() . "\n";
    exit(1);
}

try {
    $app = (new \App\Main)->run();
    \App\Singleton::response()->display($app);
} catch (\Exception $e) {
    echo "Error : " . $e->getMessage() . "\nTry typing <help>\n";
    exit(1);
}

// That's all folks !
