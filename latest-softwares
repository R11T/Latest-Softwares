#!/usr/bin/php
<?php

$required = [
    'Const.php', 'Vendor/autoload.php'
];

require_once 'dependencies.php';

loadDependencies($required);

try {
    $request = new \App\Libraries\Io\Request($argv, $argc);
    \App\Singleton::request($request);
    \App\Singleton::response((new \App\Libraries\Io\Response()));
    \App\Singleton::router((new \App\Router($request)));
    \App\Singleton::db(new \App\Libraries\Db(DATA_DIR . 'db.sqlite'));
    \App\Singleton::db()->exec('PRAGMA foreign_keys=ON');
    \App\Singleton::mainFactory(new \App\Libraries\Factory());

} catch (\Exception $e) {
    if (!is_object(\App\Singleton::response())) {
        \App\Singleton::response((new \App\Libraries\Io\Response()));
    }
    \App\Singleton::response()->display('Fatal error : ' . $e->getMessage());
    exit(1);
}

try {
    $controller = new \App\Main();
    $controller->run();
} catch (\Exception $e) {
    if (!is_object(\App\Singleton::response())) {
        \App\Singleton::response((new \App\Libraries\Io\Response()));
    }
    \App\Singleton::response()->display('Error : ' . $e->getMessage() . "\nTry typing <help>");
    exit(1);
}

// That's all folks !
